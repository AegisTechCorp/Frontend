echo "üîí Running pre-push checks..."

# Check for sensitive files in commits to be pushed
echo "üîç Checking for sensitive files..."
SENSITIVE_FILES=$(git diff --name-only origin/$(git rev-parse --abbrev-ref HEAD)..HEAD 2>/dev/null | grep -E "\.env$|\.env\.|credentials\.json|secrets\.json|\.pem$|\.key$|\.p12$|\.pfx$|id_rsa|\.aws/credentials" || true)
if [ -n "$SENSITIVE_FILES" ]; then
  echo "‚ùå ERROR: Sensitive files detected in commits to be pushed!"
  echo "$SENSITIVE_FILES"
  echo "These files should NEVER be committed!"
  echo "Tip: Add them to .gitignore and remove from git history"
  exit 1
fi

# Scan for secrets in commits about to be pushed
echo "üîç Scanning commits for secrets..."
# Only detect actual secret values, not code that uses variables
# Looks for: key="actual_value" or token='xyz123' or Bearer followed by long token
if git diff origin/$(git rev-parse --abbrev-ref HEAD)..HEAD 2>/dev/null | grep -iE "(password\s*=\s*['\"][^'\"]{8,}['\"]|api_key\s*=\s*['\"][^'\"]{20,}['\"]|secret_key\s*=\s*['\"][^'\"]{20,}['\"]|private_key\s*=\s*['\"]|Bearer\s+[A-Za-z0-9\-_]{40,})" | grep -v "mock" | grep -v "test" | grep -v "example" | grep -v "placeholder"; then
  echo "‚ùå ERROR: Potential secret detected in commits to be pushed!"
  echo "Please remove secrets before pushing."
  echo "Tip: Use environment variables or .env files (and add them to .gitignore)"
  exit 1
fi

echo " Running security audit..."
npm audit --audit-level=moderate || exit 1

echo " Running tests..."
npm run test || exit 1

echo " Running build..."
npm run build || exit 1

echo " All checks passed! Pushing..."